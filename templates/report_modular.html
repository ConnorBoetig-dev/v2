<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scan Report - {{ scan_date }}</title>
    
    <!-- Modular CSS Files -->
    <link rel="stylesheet" href="../../static/css/base.css">
    <link rel="stylesheet" href="../../static/css/components.css">
    <link rel="stylesheet" href="../../static/css/layout.css">
    <link rel="stylesheet" href="../../static/css/animations.css">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="container">
            <div class="header-content">
                <div class="header-brand">
                    <div class="header-title">NetworkMapper</div>
                    <span class="badge badge-primary">v2.0</span>
                </div>
                <div class="header-nav">
                    <span class="text-muted">Scan Date: {{ timestamp }}</span>
                    <button class="btn btn-glass" onclick="toggleTheme()">
                        <i data-feather="moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero">
                <h1 class="hero-title animate-fadeInDown">Network Scan Report</h1>
                <p class="hero-subtitle animate-fadeInUp">
                    Comprehensive analysis of {{ total_devices }} devices across your network
                </p>
                
                <!-- Quick Actions -->
                <div class="flex justify-center gap-md animate-fadeIn" style="animation-delay: 0.3s;">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i data-feather="printer"></i>
                        Print Report
                    </button>
                    <button class="btn btn-secondary" onclick="downloadCSV()">
                        <i data-feather="download"></i>
                        Export CSV
                    </button>
                    <button class="btn btn-accent{% if has_changes %} animate-pulse{% endif %}" onclick="compareToLastScan()">
                        <i data-feather="git-branch"></i>
                        Compare Scans
                        {% if has_changes %}
                        <span class="badge badge-warning">New!</span>
                        {% endif %}
                    </button>
                    <button class="btn btn-glass" onclick="refreshScan()">
                        <i data-feather="refresh-cw"></i>
                        New Scan
                    </button>
                </div>
            </section>

            <!-- Statistics Dashboard -->
            <section class="section">
                <div class="dashboard-stats stagger-animation">
                    <!-- Total Devices -->
                    <div class="stat-card glass hover-lift">
                        <div class="stat-card-header">
                            <div class="stat-card-icon glass" style="background: var(--gradient-primary);">
                                <i data-feather="server" style="color: white;"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ total_devices }}</div>
                        <div class="stat-card-label">Total Devices</div>
                        <div class="stat-card-trend up">
                            <i data-feather="trending-up"></i>
                            <span>+{{ new_devices|length }} new</span>
                        </div>
                    </div>

                    <!-- Critical Infrastructure -->
                    <div class="stat-card glass hover-lift">
                        <div class="stat-card-header">
                            <div class="stat-card-icon glass" style="background: var(--gradient-danger);">
                                <i data-feather="alert-triangle" style="color: white;"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ critical_devices|length }}</div>
                        <div class="stat-card-label">Critical Devices</div>
                        {% if critical_devices|length > 0 %}
                        <div class="stat-card-trend down">
                            <i data-feather="alert-circle"></i>
                            <span>Attention needed</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Device Types -->
                    <div class="stat-card glass hover-lift">
                        <div class="stat-card-header">
                            <div class="stat-card-icon glass" style="background: var(--gradient-info);">
                                <i data-feather="layers" style="color: white;"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ device_types|length }}</div>
                        <div class="stat-card-label">Device Types</div>
                        <div class="progress" style="margin-top: 1rem;">
                            <div class="progress-bar" style="width: 100%;"></div>
                        </div>
                    </div>

                    <!-- Security Status -->
                    <div class="stat-card glass hover-lift">
                        {% set vulnerable_count = devices|selectattr('vulnerability_count', 'greaterthan', 0)|list|length %}
                        <div class="stat-card-header">
                            <div class="stat-card-icon glass" style="background: {% if vulnerable_count > 0 %}var(--gradient-warning){% else %}var(--gradient-success){% endif %};">
                                <i data-feather="shield" style="color: white;"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ vulnerable_count }}</div>
                        <div class="stat-card-label">Vulnerable Devices</div>
                        <div class="stat-card-trend {% if vulnerable_count > 0 %}down{% else %}up{% endif %}">
                            <i data-feather="{% if vulnerable_count > 0 %}shield-off{% else %}shield{% endif %}"></i>
                            <span>{% if vulnerable_count > 0 %}Action required{% else %}Secure{% endif %}</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tabs Navigation -->
            <div class="tabs glass" style="margin-bottom: 2rem;">
                <button class="tab active" onclick="showTab('devices', this)">
                    <i data-feather="monitor" style="width: 16px; height: 16px;"></i>
                    Devices
                </button>
                <button class="tab" onclick="showTab('security', this)">
                    <i data-feather="shield" style="width: 16px; height: 16px;"></i>
                    Security
                </button>
                <button class="tab" onclick="showTab('services', this)">
                    <i data-feather="globe" style="width: 16px; height: 16px;"></i>
                    Services
                </button>
                <button class="tab" onclick="showTab('network', this)">
                    <i data-feather="git-branch" style="width: 16px; height: 16px;"></i>
                    Network Map
                </button>
                <button class="tab" onclick="showTab('insights', this)">
                    <i data-feather="trending-up" style="width: 16px; height: 16px;"></i>
                    Insights
                </button>
            </div>

            <!-- Tab Contents -->
            <!-- Devices Tab -->
            <div id="devices-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title gradient-text">Discovered Devices</h2>
                    <p class="section-subtitle">Complete inventory of all network devices</p>
                </div>

                <!-- Device Grid View -->
                <div class="dashboard-grid animate-fadeIn">
                    {% for device in devices %}
                    <div class="device-card glass hover-lift type-{{ device.type }}{% if device.critical %} critical{% endif %}" 
                         onclick="showDeviceDetails('{{ device.ip }}')">
                        <div class="device-card-header">
                            <span class="device-card-ip">{{ device.ip }}</span>
                            <div class="device-card-status{% if device.critical %} critical{% endif %}{% if device.vulnerability_count > 0 %} warning{% endif %}"></div>
                        </div>
                        
                        <div class="flex items-center gap-sm" style="margin: 1rem 0;">
                            <span class="badge badge-primary">{{ device.type|upper }}</span>
                            {% if device.critical %}
                            <span class="badge badge-danger">CRITICAL</span>
                            {% endif %}
                            {% if device.vulnerability_count > 0 %}
                            <span class="badge badge-warning">{{ device.vulnerability_count }} VULNS</span>
                            {% endif %}
                        </div>
                        
                        <div style="color: var(--text-muted); font-size: var(--text-sm);">
                            {% if device.hostname %}<div><strong>Hostname:</strong> {{ device.hostname }}</div>{% endif %}
                            {% if device.vendor %}<div><strong>Vendor:</strong> {{ device.vendor }}</div>{% endif %}
                            {% if device.os %}<div><strong>OS:</strong> {{ device.os }}</div>{% endif %}
                            {% if device.services %}
                            <div style="margin-top: 0.5rem;">
                                <strong>Services:</strong>
                                <div class="flex flex-wrap gap-xs" style="margin-top: 0.25rem;">
                                    {% for service in device.services[:3] %}
                                    <span class="badge badge-primary" style="font-size: 0.7rem;">{{ service.split(':')[0] }}</span>
                                    {% endfor %}
                                    {% if device.services|length > 3 %}
                                    <span class="badge badge-primary" style="font-size: 0.7rem;">+{{ device.services|length - 3 }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Table View Toggle -->
                <div class="flex justify-end" style="margin: 2rem 0;">
                    <button class="btn btn-glass" onclick="toggleView()">
                        <i data-feather="list"></i>
                        Table View
                    </button>
                </div>

                <!-- Device Table (Hidden by default) -->
                <div id="device-table-view" class="table-container glass" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Hostname</th>
                                <th>Type</th>
                                <th>Vendor</th>
                                <th>OS</th>
                                <th>Services</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <td style="font-family: var(--font-mono);">{{ device.ip }}</td>
                                <td>{{ device.hostname or '-' }}</td>
                                <td><span class="badge badge-primary">{{ device.type }}</span></td>
                                <td>{{ device.vendor or '-' }}</td>
                                <td>{{ device.os or '-' }}</td>
                                <td>
                                    {% if device.services %}
                                    <div class="flex flex-wrap gap-xs">
                                        {% for service in device.services[:2] %}
                                        <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ service }}</span>
                                        {% endfor %}
                                        {% if device.services|length > 2 %}
                                        <span class="text-muted" style="font-size: 0.7rem;">+{{ device.services|length - 2 }} more</span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if device.critical %}
                                    <span class="badge badge-danger">CRITICAL</span>
                                    {% elif device.vulnerability_count > 0 %}
                                    <span class="badge badge-warning">AT RISK</span>
                                    {% else %}
                                    <span class="badge badge-success">SECURE</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-glass" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                            onclick="showDeviceDetails('{{ device.ip }}')">
                                        <i data-feather="eye" style="width: 16px; height: 16px;"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Security Tab -->
            <div id="security-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title gradient-text">Security Analysis</h2>
                    <p class="section-subtitle">Vulnerability assessment and risk overview</p>
                </div>

                {% set vulnerable_devices = devices|selectattr('vulnerability_count', 'greaterthan', 0)|list %}
                {% set critical_vulns = devices|selectattr('critical_vulns', 'greaterthan', 0)|list %}
                {% set high_vulns = devices|selectattr('high_vulns', 'greaterthan', 0)|list %}

                <!-- Security Overview -->
                <div class="grid grid-cols-4 gap-lg" style="margin-bottom: 2rem;">
                    <div class="card glass hover-lift">
                        <h3 style="color: var(--color-red); margin-bottom: 1rem;">Critical Risk</h3>
                        <div class="stat-card-value" style="color: var(--color-red);">{{ critical_vulns|length }}</div>
                        <div class="text-muted">Devices</div>
                    </div>
                    <div class="card glass hover-lift">
                        <h3 style="color: var(--color-orange); margin-bottom: 1rem;">High Risk</h3>
                        <div class="stat-card-value" style="color: var(--color-orange);">{{ high_vulns|length }}</div>
                        <div class="text-muted">Devices</div>
                    </div>
                    <div class="card glass hover-lift">
                        <h3 style="color: var(--color-yellow); margin-bottom: 1rem;">Total Vulnerable</h3>
                        <div class="stat-card-value" style="color: var(--color-yellow);">{{ vulnerable_devices|length }}</div>
                        <div class="text-muted">Devices</div>
                    </div>
                    <div class="card glass hover-lift">
                        <h3 style="color: var(--color-green); margin-bottom: 1rem;">Secure</h3>
                        <div class="stat-card-value" style="color: var(--color-green);">{{ devices|length - vulnerable_devices|length }}</div>
                        <div class="text-muted">Devices</div>
                    </div>
                </div>

                {% if vulnerable_devices %}
                <!-- Vulnerable Devices -->
                <div class="card glass">
                    <h3 style="margin-bottom: 1rem;">Vulnerable Devices</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Risk Level</th>
                                    <th>Vulnerabilities</th>
                                    <th>Top CVEs</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in vulnerable_devices|sort(attribute='critical_vulns', reverse=true) %}
                                <tr>
                                    <td>
                                        <div><strong>{{ device.ip }}</strong></div>
                                        <div class="text-muted" style="font-size: 0.875rem;">{{ device.hostname or device.type }}</div>
                                    </td>
                                    <td>
                                        {% if device.get('critical_vulns', 0) > 0 %}
                                        <span class="badge badge-danger">CRITICAL</span>
                                        {% elif device.get('high_vulns', 0) > 0 %}
                                        <span class="badge badge-warning">HIGH</span>
                                        {% else %}
                                        <span class="badge badge-warning">MEDIUM</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="flex items-center gap-sm">
                                            <span class="stat-card-value" style="font-size: 1.5rem;">{{ device.vulnerability_count }}</span>
                                            <div>
                                                {% if device.get('critical_vulns', 0) > 0 %}
                                                <div class="text-muted" style="font-size: 0.75rem;">{{ device.critical_vulns }} critical</div>
                                                {% endif %}
                                                {% if device.get('high_vulns', 0) > 0 %}
                                                <div class="text-muted" style="font-size: 0.75rem;">{{ device.high_vulns }} high</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if device.get('vulnerabilities') %}
                                        <div class="flex flex-col gap-xs">
                                            {% for vuln in device.vulnerabilities[:3] %}
                                            <span class="badge badge-danger" style="font-size: 0.75rem;">
                                                {{ vuln.cve_id }} ({{ vuln.cvss_score|round(1) }})
                                            </span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-glass" style="padding: 0.25rem 0.5rem;" 
                                                onclick="showVulnerabilityDetails('{{ device.ip }}')">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <!-- All Secure -->
                <div class="card glass" style="text-align: center; padding: 3rem;">
                    <div class="animate-bounceIn">
                        <i data-feather="shield" style="width: 64px; height: 64px; color: var(--color-green); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--color-green);">All Systems Secure</h3>
                        <p class="text-muted">No vulnerabilities detected in the current scan</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Services Tab -->
            <div id="services-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title gradient-text">Network Services</h2>
                    <p class="section-subtitle">Overview of running services and open ports</p>
                </div>

                {% set all_services = [] %}
                {% for device in devices %}
                    {% for service in device.get('services', []) %}
                        {% if all_services.append(service) %}{% endif %}
                    {% endfor %}
                {% endfor %}
                
                {% set service_summary = {} %}
                {% for service in all_services %}
                    {% set service_name = service.split(':')[0] %}
                    {% if service_summary.update({service_name: service_summary.get(service_name, 0) + 1}) %}{% endif %}
                {% endfor %}

                <!-- Service Distribution -->
                {% set sorted_services = service_summary.items()|sort(attribute=1, reverse=true)|list %}
                <div class="grid grid-cols-6 gap-md" style="margin-bottom: 2rem;">
                    {% for service, count in sorted_services[:12] %}
                    <div class="card glass hover-lift" style="text-align: center;">
                        <div class="stat-card-icon glass" style="margin: 0 auto 1rem; background: var(--gradient-info);">
                            <i data-feather="globe" style="color: white;"></i>
                        </div>
                        <h4 style="text-transform: uppercase; font-size: 0.875rem; margin-bottom: 0.5rem;">{{ service }}</h4>
                        <div class="stat-card-value" style="font-size: 2rem;">{{ count }}</div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Detailed Service List -->
                <div class="card glass">
                    <h3 style="margin-bottom: 1rem;">Service Details by Device</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Open Ports</th>
                                    <th>Services</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices|selectattr('services') %}
                                <tr>
                                    <td>
                                        <div><strong>{{ device.ip }}</strong></div>
                                        <div class="text-muted" style="font-size: 0.875rem;">{{ device.hostname or device.type }}</div>
                                    </td>
                                    <td>
                                        {% if device.open_ports %}
                                        <div class="flex flex-wrap gap-xs">
                                            {% for port in device.open_ports[:10] %}
                                            <span class="badge badge-secondary" style="font-size: 0.75rem;">{{ port }}</span>
                                            {% endfor %}
                                            {% if device.open_ports|length > 10 %}
                                            <span class="text-muted">+{{ device.open_ports|length - 10 }}</span>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="flex flex-wrap gap-xs">
                                            {% for service in device.services %}
                                            <span class="badge badge-primary" style="font-size: 0.75rem;">{{ service }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Network Map Tab -->
            <div id="network-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title gradient-text">Network Topology</h2>
                    <p class="section-subtitle">Visual representation of your network infrastructure</p>
                </div>

                <div class="card glass" style="height: 600px; position: relative;">
                    <div class="flex justify-center items-center" style="height: 100%;">
                        <div class="text-center">
                            <i data-feather="git-branch" style="width: 64px; height: 64px; color: var(--color-blue); margin-bottom: 1rem;"></i>
                            <h3>Interactive Network Map</h3>
                            <p class="text-muted" style="margin-bottom: 1rem;">Visualize your network topology in 2D or 3D</p>
                            <button class="btn btn-primary" onclick="openNetworkVisualization()">
                                <i data-feather="maximize"></i>
                                Open Network Visualization
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Subnet Summary -->
                <h3 style="margin: 2rem 0 1rem;">Subnet Overview</h3>
                <div class="grid grid-cols-3 gap-lg">
                    {% for subnet in subnet_summary %}
                    <div class="card glass hover-lift">
                        <h4 style="color: var(--color-blue); margin-bottom: 1rem;">{{ subnet.network }}</h4>
                        <div class="flex justify-between items-center" style="margin-bottom: 0.5rem;">
                            <span class="text-muted">Total Devices</span>
                            <span class="badge badge-primary">{{ subnet.device_count }}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.5rem;">Device Types:</div>
                            <div class="flex flex-wrap gap-xs">
                                {% for type, count in subnet.types.items() %}
                                <span class="badge badge-secondary" style="font-size: 0.75rem;">{{ type }} ({{ count }})</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title gradient-text">Network Insights</h2>
                    <p class="section-subtitle">Key findings and recommendations</p>
                </div>

                <div class="grid grid-cols-2 gap-lg">
                    <!-- Key Findings -->
                    <div class="card glass">
                        <h3 style="margin-bottom: 1rem;">
                            <i data-feather="search" style="width: 20px; height: 20px; vertical-align: middle;"></i>
                            Key Findings
                        </h3>
                        <div class="flex flex-col gap-md">
                            {% if critical_devices|length > 0 %}
                            <div class="alert alert-error">
                                <i data-feather="alert-triangle" class="alert-icon"></i>
                                <div class="alert-content">
                                    <strong>{{ critical_devices|length }} critical devices</strong> detected that require immediate attention
                                </div>
                            </div>
                            {% endif %}
                            
                            {% set vulnerable_count = devices|selectattr('vulnerability_count', 'greaterthan', 0)|list|length %}
                            {% if vulnerable_count > 0 %}
                            <div class="alert alert-warning">
                                <i data-feather="shield-off" class="alert-icon"></i>
                                <div class="alert-content">
                                    <strong>{{ vulnerable_count }} devices</strong> have known vulnerabilities
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if new_devices|length > 0 %}
                            <div class="alert alert-info">
                                <i data-feather="plus-circle" class="alert-icon"></i>
                                <div class="alert-content">
                                    <strong>{{ new_devices|length }} new devices</strong> discovered since last scan
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="alert alert-success">
                                <i data-feather="check-circle" class="alert-icon"></i>
                                <div class="alert-content">
                                    Successfully scanned <strong>{{ total_devices }} devices</strong> across {{ subnet_summary|length }} subnets
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card glass">
                        <h3 style="margin-bottom: 1rem;">
                            <i data-feather="list" style="width: 20px; height: 20px; vertical-align: middle;"></i>
                            Recommendations
                        </h3>
                        <div class="flex flex-col gap-md">
                            {% if vulnerable_count > 0 %}
                            <div class="flex items-start gap-md">
                                <div class="badge badge-danger" style="margin-top: 0.25rem;">1</div>
                                <div>
                                    <strong>Patch Vulnerable Systems</strong>
                                    <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
                                        Apply security updates to {{ vulnerable_count }} vulnerable devices
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="flex items-start gap-md">
                                <div class="badge badge-warning" style="margin-top: 0.25rem;">2</div>
                                <div>
                                    <strong>Review Open Services</strong>
                                    <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
                                        Verify that all {{ all_services|length }} detected services are necessary
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-md">
                                <div class="badge badge-primary" style="margin-top: 0.25rem;">3</div>
                                <div>
                                    <strong>Monitor Critical Infrastructure</strong>
                                    <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
                                        Set up continuous monitoring for critical devices
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Type Distribution -->
                <div class="card glass" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Device Type Distribution</h3>
                    <div class="grid grid-cols-4 gap-md">
                        {% for type, count in device_types.items() %}
                        <div class="flex items-center justify-between padding-md glass" style="border-radius: var(--radius-md);">
                            <span class="badge badge-primary">{{ type|upper }}</span>
                            <span class="text-2xl font-bold">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer glass">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Scan Information</h4>
                    <div class="text-muted" style="font-size: 0.875rem;">
                        <div>Start Time: {{ scan_metadata.start_time | default('Unknown') }}</div>
                        <div>Duration: {{ scan_metadata.duration | default('N/A') }}</div>
                        <div>Target: {{ scan_metadata.target | default('Unknown') }}</div>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Scan Parameters</h4>
                    <div class="flex flex-col gap-xs">
                        <span class="badge badge-{% if scan_metadata.scan_parameters.snmp_enabled %}success{% else %}secondary{% endif %}">
                            SNMP: {{ 'Enabled' if scan_metadata.scan_parameters.snmp_enabled else 'Disabled' }}
                        </span>
                        <span class="badge badge-{% if scan_metadata.scan_parameters.vulnerability_scan %}success{% else %}secondary{% endif %}">
                            Vulnerability Scan: {{ 'Enabled' if scan_metadata.scan_parameters.vulnerability_scan else 'Disabled' }}
                        </span>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Summary</h4>
                    <div class="text-muted" style="font-size: 0.875rem;">
                        <div>Total Devices: {{ total_devices }}</div>
                        <div>Subnets: {{ subnet_summary|length }}</div>
                        <div>Services: {{ all_services|length }}</div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Generated by NetworkMapper v2.0 â€¢ {{ scan_date }}</p>
            </div>
        </div>
    </footer>

    <!-- Device Details Modal -->
    <div class="modal-backdrop" id="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal glass" id="device-modal">
        <div style="padding: 2rem;">
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
                <h2 id="modal-title">Device Details</h2>
                <button class="btn btn-glass" onclick="closeModal()" style="padding: 0.5rem;">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div id="modal-content">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialize Feather icons
        feather.replace();

        // Global data
        const devicesData = {{ devices | tojson }};
        const scanTimestamp = '{{ scan_timestamp }}';

        // Tab switching
        function showTab(tabName, tabElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            tabElement.classList.add('active');
            
            // Reinitialize icons
            feather.replace();
        }

        // Toggle between grid and table view
        function toggleView() {
            const gridView = document.querySelector('.dashboard-grid');
            const tableView = document.getElementById('device-table-view');
            const button = event.target.closest('button');
            
            if (gridView.style.display === 'none') {
                gridView.style.display = 'grid';
                tableView.style.display = 'none';
                button.innerHTML = '<i data-feather="list"></i> Table View';
            } else {
                gridView.style.display = 'none';
                tableView.style.display = 'block';
                button.innerHTML = '<i data-feather="grid"></i> Grid View';
            }
            
            feather.replace();
        }

        // Show device details modal
        function showDeviceDetails(ip) {
            const device = devicesData.find(d => d.ip === ip);
            if (!device) return;
            
            const modal = document.getElementById('device-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            title.textContent = `Device: ${device.ip}`;
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-lg">
                    <div>
                        <h4 style="margin-bottom: 1rem;">Basic Information</h4>
                        <div class="flex flex-col gap-sm">
                            <div><strong>IP Address:</strong> ${device.ip}</div>
                            <div><strong>Hostname:</strong> ${device.hostname || 'N/A'}</div>
                            <div><strong>MAC Address:</strong> ${device.mac || 'N/A'}</div>
                            <div><strong>Vendor:</strong> ${device.vendor || 'N/A'}</div>
                            <div><strong>Type:</strong> <span class="badge badge-primary">${device.type}</span></div>
                            <div><strong>OS:</strong> ${device.os || 'N/A'}</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem;">Security Status</h4>
                        <div class="flex flex-col gap-sm">
                            <div><strong>Critical:</strong> ${device.critical ? '<span class="badge badge-danger">YES</span>' : '<span class="badge badge-success">NO</span>'}</div>
                            <div><strong>Vulnerabilities:</strong> ${device.vulnerability_count || 0}</div>
                            <div><strong>Last Seen:</strong> ${device.last_seen || 'N/A'}</div>
                            <div><strong>First Seen:</strong> ${device.first_seen || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${device.services && device.services.length > 0 ? `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Services</h4>
                    <div class="flex flex-wrap gap-sm">
                        ${device.services.map(service => `<span class="badge badge-secondary">${service}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${device.open_ports && device.open_ports.length > 0 ? `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Open Ports</h4>
                    <div class="flex flex-wrap gap-sm">
                        ${device.open_ports.map(port => `<span class="badge badge-primary">${port}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            backdrop.classList.add('show');
            modal.classList.add('show');
            feather.replace();
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('device-modal');
            const backdrop = document.getElementById('modal-backdrop');
            backdrop.classList.remove('show');
            modal.classList.remove('show');
        }

        // Download CSV
        function downloadCSV() {
            let csv = 'IP,Hostname,MAC,Vendor,Type,OS,Services,Open Ports,Vulnerability Count,Critical,Notes\n';

            devicesData.forEach(device => {
                const row = [
                    device.ip,
                    device.hostname || '',
                    device.mac || '',
                    device.vendor || '',
                    device.type || 'unknown',
                    device.os || '',
                    (device.services || []).join(';'),
                    (device.open_ports || []).join(';'),
                    device.vulnerability_count || 0,
                    device.critical ? 'Yes' : 'No',
                    device.notes || ''
                ];

                const escapedRow = row.map(value => {
                    const str = String(value);
                    return str.includes(',') ? `"${str}"` : str;
                });

                csv += escapedRow.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network_scan_${scanTimestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Compare to last scan
        function compareToLastScan() {
            {% if comparison_file %}
                window.location.href = '{{ comparison_file }}';
            {% else %}
                alert('No comparison report available. Run at least 2 scans to see comparisons.');
            {% endif %}
        }

        // Refresh scan
        function refreshScan() {
            alert('To run a new scan, please return to the NetworkMapper CLI');
        }

        // Open network visualization
        function openNetworkVisualization() {
            window.open(`network_visualization_${scanTimestamp}.html`, '_blank');
        }

        // Theme toggle (placeholder)
        function toggleTheme() {
            alert('Theme switching coming soon!');
        }

        // Add smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>