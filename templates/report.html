<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scan Report - {{ scan_date }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #cccccc;
            background: #1e1e1e;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #4a5fc1 0%, #6b46c1 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .quick-actions {
            background: #252526;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #3e3e42;
        }

        .quick-actions h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #569cd6;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: #569cd6;
            color: white;
        }

        .btn-primary:hover {
            background: #4b8bc8;
        }

        .btn-secondary {
            background: #4ec9b0;
            color: white;
        }

        .btn-secondary:hover {
            background: #43b59f;
        }

        .btn-info {
            background: #4fc1e9;
            color: white;
        }

        .btn-info:hover {
            background: #3badd6;
        }

        .btn-warning {
            background: #ce9178;
            color: white;
        }

        .btn-warning:hover {
            background: #bb8166;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: #2d2d30;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            border: 1px solid #3e3e42;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .summary-card h3 {
            color: #569cd6;
            margin-bottom: 0.5rem;
        }

        .summary-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #d4d4d4;
        }

        .tabs {
            display: flex;
            background: #2d2d30;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #3e3e42;
            border-bottom: none;
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #2d2d30;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1rem;
            font-weight: 500;
            color: #cccccc;
        }

        .tab:hover {
            background: #333337;
        }

        .tab.active {
            background: #1e1e1e;
            color: #569cd6;
            border-bottom: 3px solid #569cd6;
        }

        .tab-content {
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
            border: 1px solid #3e3e42;
            border-top: none;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #3e3e42;
        }

        .device-table th {
            background: #2d2d30;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #cccccc;
            border-bottom: 2px solid #3e3e42;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .device-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #3e3e42;
            color: #d4d4d4;
        }

        .device-table tr:hover {
            background: #2d2d30;
        }

        .device-table tr:last-child td {
            border-bottom: none;
        }

        .device-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .type-router {
            background: #5a3232;
            color: #f48771;
        }

        .type-switch {
            background: #2b3f5c;
            color: #7ca9dd;
        }

        .type-server,
        .type-windows_server,
        .type-linux_server,
        .type-web_server,
        .type-database {
            background: #2d4a3d;
            color: #6fc28b;
        }

        .type-workstation {
            background: #4a3a5a;
            color: #b99bd8;
        }

        .type-printer {
            background: #5a4226;
            color: #daa674;
        }

        .type-iot {
            background: #5a5226;
            color: #d4c896;
        }

        .type-unknown {
            background: #3e3e42;
            color: #858585;
        }

        .critical {
            color: #f48771;
            font-weight: bold;
        }

        .services {
            font-size: 0.875rem;
            color: #858585;
        }

        .visualization {
            width: 100%;
            height: 600px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .visualization-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 5px;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }

        .control-btn:hover {
            background: #e9ecef;
            color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .node-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            color: #333;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 280px;
            min-width: 200px;
        }

        .node-tooltip h4 {
            color: #007bff;
            margin-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 6px;
            font-size: 14px;
        }

        .node-tooltip .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            align-items: flex-start;
        }

        .node-tooltip .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 60px;
            flex-shrink: 0;
        }

        .node-tooltip .detail-value {
            color: #333;
            text-align: right;
            word-break: break-word;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .device-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #252526;
            border-left: 1px solid #3e3e42;
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.4);
        }

        .device-sidebar.open {
            right: 0;
        }

        .device-info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 280px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            color: #333;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .device-info-panel h4 {
            color: #007bff;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            font-size: 14px;
        }

        .device-info-panel .info-content {
            overflow-y: auto;
            max-height: 350px;
        }

        .device-info-panel .info-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            align-items: flex-start;
        }

        .device-info-panel .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
            flex-shrink: 0;
        }

        .device-info-panel .info-value {
            color: #333;
            text-align: right;
            word-break: break-word;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .device-info-panel .device-title {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }

        .sidebar-header {
            background: #2d2d30;
            padding: 1rem;
            border-bottom: 2px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            color: #569cd6;
            font-size: 1.1rem;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: #858585;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .sidebar-close:hover {
            background: #1e1e1e;
            color: #f48771;
        }

        .sidebar-content {
            padding: 1rem;
        }

        .sidebar-section {
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .sidebar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .sidebar-section h3 {
            color: #569cd6;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-section h3::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #569cd6;
            border-radius: 2px;
        }

        .sidebar-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 0.75rem 1rem;
            align-items: start;
        }

        .sidebar-label {
            color: #cccccc;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .sidebar-value {
            color: #d4d4d4;
            word-break: break-all;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            background: #1e1e1e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #3e3e42;
        }

        #network-2d,
        #network-3d {
            width: 100%;
            height: 100%;
            background: #ffffff;
        }

        .subnet-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .subnet-card {
            background: #252526;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            transition: transform 0.2s;
        }

        .subnet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .subnet-card h4 {
            color: #569cd6;
            margin-bottom: 0.5rem;
        }

        .subnet-card ul {
            list-style: none;
            padding-left: 0;
        }

        .subnet-card li {
            color: #cccccc;
            padding: 0.25rem 0;
        }

        .hidden {
            display: none !important;
        }

        .map-controls {
            background: #252526;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .map-control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .map-control-group label {
            color: #cccccc;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .map-control-group input[type="checkbox"] {
            accent-color: #569cd6;
        }

        .map-control-group select {
            background: #2d2d30;
            color: #cccccc;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            color: #333;
            font-size: 1.2rem;
            z-index: 500;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Enhanced styles for network connections - FIXED */
        .links line {
            fill: none;
            stroke-opacity: 0.6;
            stroke-width: 2;
        }

        .links line.backbone {
            stroke: #ff4444;
            stroke-width: 3;
        }

        .links line.uplink {
            stroke: #0088cc;
            stroke-width: 2.5;
        }

        .links line.server_link {
            stroke: #00aa44;
            stroke-width: 2;
        }

        .links line.access {
            stroke: #8844aa;
            stroke-width: 1.5;
        }

        .links line.peripheral {
            stroke: #ffaa00;
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }

        .links line.application {
            stroke: #0066ff;
            stroke-width: 2;
            stroke-dasharray: 3, 3;
        }

        .links line.critical {
            stroke: #ff0000;
            stroke-width: 3;
        }

        .links line.default {
            stroke: #666666;
            stroke-width: 1.5;
        }

        /* Three.js label styles */
        .label3d {
            position: absolute;
            pointer-events: none;
            font-size: 11px;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            white-space: nowrap;
            z-index: 100;
            transition: opacity 0.3s;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .label3d.critical {
            border-color: #ff0000;
            color: #ff0000;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.95);
        }

        /* Vulnerability display styles */
        .vulnerabilities {
            font-size: 0.9rem;
        }

        .vuln-count {
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .vuln-none {
            color: #27ae60;
            font-weight: 500;
        }

        .risk-level {
            text-align: center;
        }

        .risk-critical {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .risk-high {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .risk-medium {
            background: #f1c40f;
            color: #2c3e50;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .risk-low {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Security Report styles */
        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card.critical {
            border-color: #e74c3c;
        }

        .stat-card.high {
            border-color: #f39c12;
        }

        .stat-card.medium {
            border-color: #f1c40f;
        }

        .stat-card.low {
            border-color: #27ae60;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-card.critical .stat-number {
            color: #e74c3c;
        }

        .stat-card.high .stat-number {
            color: #f39c12;
        }

        .stat-card.medium .stat-number {
            color: #f1c40f;
        }

        .stat-card.low .stat-number {
            color: #27ae60;
        }

        .stat-label {
            color: #858585;
            font-size: 0.9rem;
        }

        .cve-list {
            font-size: 0.9rem;
        }

        .cve-item {
            margin: 2px 0;
        }

        .cve-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: bold;
        }

        .cve-score {
            color: #858585;
            font-size: 0.8rem;
        }

        .no-vulnerabilities {
            text-align: center;
            padding: 3rem;
            background: #252526;
            border: 1px solid #27ae60;
            border-radius: 8px;
        }

        /* Services tab styles */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .service-card {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .service-name {
            font-weight: bold;
            color: #569cd6;
            margin-bottom: 0.5rem;
        }

        .service-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ec9b0;
        }

        .service-label {
            color: #858585;
            font-size: 0.8rem;
        }

        .service-item {
            margin: 2px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .ports {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .device-table {
                font-size: 0.875rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .device-sidebar {
                width: 100vw;
                right: -100vw;
            }

            .visualization-controls {
                position: relative;
                top: auto;
                right: auto;
                flex-direction: row;
                justify-content: center;
                margin-bottom: 10px;
            }

            .map-controls {
                flex-direction: column;
                gap: 1rem;
            }

            .map-control-group {
                justify-content: space-between;
                width: 100%;
            }

            .node-tooltip {
                max-width: calc(100vw - 40px);
                font-size: 12px;
            }

            .sidebar-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .sidebar-label {
                font-weight: 600;
                color: #569cd6;
            }
        }

        @media print {
            body {
                background: white;
                color: black;
            }

            .quick-actions,
            .tabs,
            .tab-content.hidden,
            .visualization-controls,
            .device-sidebar,
            .map-controls,
            .loading-overlay {
                display: none !important;
            }

            .tab-content {
                display: block !important;
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ddd;
            }

            .container {
                max-width: 100%;
            }

            .device-table th,
            .device-table td {
                border: 1px solid #ddd;
                color: black;
            }

            .summary-card,
            .subnet-card {
                background: white;
                border: 1px solid #ddd;
                color: black;
            }

            header {
                background: #667eea;
                color: white;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
        }

        .control-btn:focus,
        .action-btn:focus,
        .sidebar-close:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Network Scan Report</h1>
            <p>Generated on {{ timestamp }}</p>
        </header>

        <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="window.print()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2">
                        </path>
                        <rect x="6" y="14" width="12" height="8" rx="1"></rect>
                    </svg>
                    Print Report
                </button>

                <button class="action-btn btn-secondary" onclick="downloadCSV()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                    </svg>
                    Download CSV
                </button>

                <button class="action-btn btn-info" onclick="compareToLastScan()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="18" r="3"></circle>
                        <circle cx="6" cy="6" r="3"></circle>
                        <path d="M13 6h3a2 2 0 012 2v7M6 11h3a2 2 0 002-2V6"></path>
                    </svg>
                    Compare to Last Scan
                </button>

                <button class="action-btn btn-warning" onclick="refreshScan()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15">
                        </path>
                    </svg>
                    Run New Scan
                </button>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Devices</h3>
                <div class="number">{{ total_devices }}</div>
            </div>

            <div class="summary-card">
                <h3>Critical Devices</h3>
                <div class="number">{{ critical_devices|length }}</div>
            </div>

            <div class="summary-card">
                <h3>Device Types</h3>
                <div class="number">{{ device_types|length }}</div>
            </div>

            <div class="summary-card">
                <h3>Vulnerable Devices</h3>
                {% set vulnerable_count = devices|selectattr('vulnerability_count', 'greaterthan', 0)|list|length %}
                <div class="number" style="color: {% if vulnerable_count > 0 %}#f39c12{% else %}#27ae60{% endif %}">{{ vulnerable_count }}</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('devices')">Devices</button>
            <button class="tab" onclick="showTab('vulnerabilities')">Security Report</button>
            <button class="tab" onclick="showTab('services')">Services</button>
            <button class="tab" onclick="showTab('subnets')">Subnets</button>
        </div>

        <div id="devices-tab" class="tab-content">
            <h2>Discovered Devices</h2>
            <table class="device-table">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Hostname</th>
                        <th>Type</th>
                        <th>Vendor</th>
                        <th>OS</th>
                        <th>Services</th>
                        <th>Vulnerabilities</th>
                        <th>Risk Level</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.ip }}</td>
                        <td>{{ device.hostname or '-' }}</td>
                        <td><span class="device-type type-{{ device.type }}">{{ device.type }}</span></td>
                        <td>{{ device.vendor or '-' }}</td>
                        <td>{{ device.os or '-' }}</td>
                        <td class="services">
                            {% if device.services %}
                            {{ device.services[:3]|join(', ') }}
                            {% if device.services|length > 3 %}...{% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="vulnerabilities">
                            {% set vuln_count = device.get('vulnerability_count', 0) %}
                            {% if vuln_count > 0 %}
                            <span class="vuln-count">{{ vuln_count }}</span>
                            {% if device.get('vulnerabilities') %}
                            <br><small>{{ device.vulnerabilities[:2]|map(attribute='cve_id')|join(', ') }}
                            {% if device.vulnerabilities|length > 2 %}...{% endif %}</small>
                            {% endif %}
                            {% else %}
                            <span class="vuln-none">None</span>
                            {% endif %}
                        </td>
                        <td class="risk-level">
                            {% set critical_vulns = device.get('critical_vulns', 0) %}
                            {% set high_vulns = device.get('high_vulns', 0) %}
                            {% if critical_vulns > 0 %}
                            <span class="risk-critical">CRITICAL</span>
                            {% elif high_vulns > 0 %}
                            <span class="risk-high">HIGH</span>
                            {% elif vuln_count > 0 %}
                            <span class="risk-medium">MEDIUM</span>
                            {% else %}
                            <span class="risk-low">LOW</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.critical %}<span class="critical">CRITICAL</span>{% endif %}
                            {{ device.notes or '' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="vulnerabilities-tab" class="tab-content hidden">
            <h2>Security Report</h2>
            
            {% set vulnerable_devices = devices|selectattr('vulnerability_count', 'greaterthan', 0)|list %}
            {% set critical_devices = devices|selectattr('critical_vulns', 'greaterthan', 0)|list %}
            {% set high_devices = devices|selectattr('high_vulns', 'greaterthan', 0)|list %}
            
            <div class="security-summary">
                <div class="security-stats">
                    <div class="stat-card critical">
                        <h3>Critical Risk</h3>
                        <div class="stat-number">{{ critical_devices|length }}</div>
                        <div class="stat-label">Devices</div>
                    </div>
                    <div class="stat-card high">
                        <h3>High Risk</h3>
                        <div class="stat-number">{{ high_devices|length }}</div>
                        <div class="stat-label">Devices</div>
                    </div>
                    <div class="stat-card medium">
                        <h3>Total Vulnerable</h3>
                        <div class="stat-number">{{ vulnerable_devices|length }}</div>
                        <div class="stat-label">Devices</div>
                    </div>
                    <div class="stat-card low">
                        <h3>Secure</h3>
                        <div class="stat-number">{{ devices|length - vulnerable_devices|length }}</div>
                        <div class="stat-label">Devices</div>
                    </div>
                </div>
                
                {% if vulnerable_devices %}
                <h3>Vulnerable Devices</h3>
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Hostname</th>
                            <th>Type</th>
                            <th>Risk Level</th>
                            <th>Vulnerabilities</th>
                            <th>Top CVEs</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in vulnerable_devices|sort(attribute='critical_vulns', reverse=true) %}
                        <tr>
                            <td>{{ device.ip }}</td>
                            <td>{{ device.hostname or '-' }}</td>
                            <td><span class="device-type type-{{ device.type }}">{{ device.type }}</span></td>
                            <td class="risk-level">
                                {% if device.get('critical_vulns', 0) > 0 %}
                                <span class="risk-critical">CRITICAL</span>
                                {% elif device.get('high_vulns', 0) > 0 %}
                                <span class="risk-high">HIGH</span>
                                {% else %}
                                <span class="risk-medium">MEDIUM</span>
                                {% endif %}
                            </td>
                            <td class="vulnerabilities">
                                <span class="vuln-count">{{ device.get('vulnerability_count', 0) }}</span>
                                {% if device.get('critical_vulns', 0) > 0 %}
                                <br><small style="color: #e74c3c;">{{ device.get('critical_vulns') }} critical</small>
                                {% endif %}
                                {% if device.get('high_vulns', 0) > 0 %}
                                <br><small style="color: #f39c12;">{{ device.get('high_vulns') }} high</small>
                                {% endif %}
                            </td>
                            <td class="cve-list">
                                {% if device.get('vulnerabilities') %}
                                {% for vuln in device.vulnerabilities[:3] %}
                                <div class="cve-item">
                                    <span class="cve-id">{{ vuln.get('cve_id') }}</span>
                                    <span class="cve-score">({{ vuln.get('cvss_score', 0)|round(1) }})</span>
                                </div>
                                {% endfor %}
                                {% if device.vulnerabilities|length > 3 %}
                                <small>+{{ device.vulnerabilities|length - 3 }} more</small>
                                {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="no-vulnerabilities">
                    <h3 style="color: #27ae60;">✓ No Vulnerabilities Detected</h3>
                    <p>All scanned devices appear to be secure based on current vulnerability databases.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="services-tab" class="tab-content hidden">
            <h2>Network Services Analysis</h2>
            
            {% set all_services = [] %}
            {% for device in devices %}
                {% for service in device.get('services', []) %}
                    {% if all_services.append(service) %}{% endif %}
                {% endfor %}
            {% endfor %}
            
            {% set service_summary = {} %}
            {% for service in all_services %}
                {% set service_name = service.split(':')[0] %}
                {% if service_summary.update({service_name: service_summary.get(service_name, 0) + 1}) %}{% endif %}
            {% endfor %}
            
            <div class="services-summary">
                <h3>Service Distribution</h3>
                <div class="service-grid">
                    {% for service, count in service_summary.items() %}
                    <div class="service-card">
                        <div class="service-name">{{ service.upper() }}</div>
                        <div class="service-count">{{ count }}</div>
                        <div class="service-label">instances</div>
                    </div>
                    {% endfor %}
                </div>
                
                <h3>Detailed Service List</h3>
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Hostname</th>
                            <th>Type</th>
                            <th>Open Ports</th>
                            <th>Services</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices|selectattr('services') %}
                        <tr>
                            <td>{{ device.ip }}</td>
                            <td>{{ device.hostname or '-' }}</td>
                            <td><span class="device-type type-{{ device.type }}">{{ device.type }}</span></td>
                            <td class="ports">
                                {% if device.open_ports %}
                                {{ device.open_ports[:5]|join(', ') }}
                                {% if device.open_ports|length > 5 %}...{% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="services">
                                {% for service in device.services %}
                                <div class="service-item">{{ service }}</div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="subnets-tab" class="tab-content hidden">
            <h2>Subnet Summary</h2>
            <div class="subnet-summary">
                {% for subnet in subnet_summary %}
                <div class="subnet-card">
                    <h4>{{ subnet.network }}</h4>
                    <p><strong>Devices:</strong> {{ subnet.device_count }}</p>
                    <p><strong>Types:</strong></p>
                    <ul>
                        {% for type, count in subnet.types.items() %}
                        <li>{{ type }}: {{ count }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="device-sidebar" id="device-sidebar">
        <div class="sidebar-header">
            <h3 id="sidebar-title">Device Details</h3>
            <button class="sidebar-close" onclick="closeSidebar()">×</button>
        </div>
        <div class="sidebar-content" id="sidebar-content">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const devicesData = {{ devices | tojson }};
        const scanTimestamp = '{{ scan_timestamp }}';
        const d3Data = {{ d3_data | safe }};
        const threeData = {{ three_data | safe }};

        let svg, simulation, node, link, label, zoom, g;
        let currentLayout = 'force';
        let showLabels = true;

        let scene, camera, renderer, controls;
        let nodes3D = [];
        let connections3D = [];
        let labels3D = [];
        let autoRotate = false; // CHANGED: Default to false
        let showConnections = true;
        let show3DLabels = true;
        let manualRotation = false;

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
        }

        function downloadCSV() {
            let csv = 'IP,Hostname,MAC,Vendor,Type,OS,Services,Open Ports,Vulnerability Count,Critical Vulns,High Vulns,Critical,Notes\n';

            devicesData.forEach(device => {
                const row = [
                    device.ip,
                    device.hostname || '',
                    device.mac || '',
                    device.vendor || '',
                    device.type || 'unknown',
                    device.os || '',
                    (device.services || []).join(';'),
                    (device.open_ports || []).join(';'),
                    device.vulnerability_count || 0,
                    device.critical_vulns || 0,
                    device.high_vulns || 0,
                    device.critical ? 'Yes' : 'No',
                    device.notes || ''
                ];

                const escapedRow = row.map(value => {
                    const str = String(value);
                    return str.includes(',') ? `"${str}"` : str;
                });

                csv += escapedRow.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network_scan_${scanTimestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function compareToLastScan() {
            const comparisonUrl = `comparison_${scanTimestamp}.html`;
            fetch(comparisonUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = comparisonUrl;
                    } else {
                        alert('No comparison report available. This might be your first scan or there are no previous scans to compare against.');
                    }
                })
                .catch(() => {
                    window.location.href = comparisonUrl;
                });
        }

        function refreshScan() {
            alert('To run a new scan, please return to the NetworkMapper CLI and select "Run Network Scan"');
        }

        function initializeD3Network() {
            const container = document.getElementById('network-2d');
            const width = container.clientWidth;
            const height = container.clientHeight;

            document.getElementById('loading-2d').style.display = 'flex';

            d3.select("#network-2d").selectAll("*").remove();

            svg = d3.select("#network-2d")
                .attr("width", width)
                .attr("height", height);

            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            g = svg.append("g");

            createLayout2D();

            setTimeout(() => {
                document.getElementById('loading-2d').style.display = 'none';
            }, 500);
        }

        function createLayout2D() {
            const width = document.getElementById('network-2d').clientWidth;
            const height = document.getElementById('network-2d').clientHeight;

            g.selectAll("*").remove();

            const nodes = d3Data.nodes.map(d => ({ ...d }));
            const links = d3Data.links.map(d => ({ ...d }));

            // FIXED: Create links FIRST (so they appear behind nodes)
            link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", d => d.type || 'default')
                .style("stroke", d => {
                    const linkColors = {
                        backbone: "#ff4444",
                        uplink: "#0088cc",
                        critical: "#ff0000",
                        server_link: "#00aa44",
                        access: "#8844aa",
                        peripheral: "#ffaa00",
                        application: "#0066ff",
                        default: "#666666"
                    };
                    return linkColors[d.type] || "#666666";
                })
                .style("stroke-width", d => {
                    const widths = {
                        backbone: 3,
                        uplink: 2.5,
                        critical: 3,
                        server_link: 2,
                        access: 1.5,
                        peripheral: 1,
                        application: 2,
                        default: 1.5
                    };
                    return widths[d.type] || 1.5;
                })
                .style("stroke-opacity", 0.6)
                .style("stroke-dasharray", d => {
                    if (d.type === 'peripheral') return "5, 5";
                    if (d.type === 'application') return "3, 3";
                    return null;
                });

            // Create nodes (after links)
            node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("r", d => {
                    if (d.critical) return 14;
                    if (d.type === 'router' || d.type === 'switch') return 12;
                    return 10;
                })
                .style("fill", d => getNodeColor(d.type))
                .style("stroke", d => d.critical ? "#ff0000" : "#333")
                .style("stroke-width", d => d.critical ? 3 : 2)
                .style("cursor", "pointer")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Set up simulation
            if (currentLayout === 'force') {
                simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(100).strength(0.5))
                    .force("charge", d3.forceManyBody().strength(-500))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(30))
                    .alphaMin(0.001)
                    .alphaDecay(0.02);
            } else if (currentLayout === 'circular') {
                const deviceTypes = [...new Set(nodes.map(n => n.type))];
                const angleStep = (2 * Math.PI) / deviceTypes.length;

                nodes.forEach((node, i) => {
                    const typeIndex = deviceTypes.indexOf(node.type);
                    const radius = 150 + (typeIndex * 50);
                    const angle = angleStep * typeIndex + (i * 0.3);
                    node.fx = width / 2 + radius * Math.cos(angle);
                    node.fy = height / 2 + radius * Math.sin(angle);
                });

                simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(50));
            } else if (currentLayout === 'grid') {
                const cols = Math.ceil(Math.sqrt(nodes.length));
                const cellWidth = width / cols;
                const cellHeight = height / Math.ceil(nodes.length / cols);

                nodes.forEach((node, i) => {
                    node.fx = (i % cols) * cellWidth + cellWidth / 2;
                    node.fy = Math.floor(i / cols) * cellHeight + cellHeight / 2;
                });

                simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id));
            }

            // Add hover effects to nodes
            node
                .on("mouseover", function (event, d) {
                    showTooltip2D(event, d);
                    d3.select(this).style("stroke-width", 4).style("stroke", "#0066ff");

                    // Highlight connected links
                    link.style("stroke-opacity", l =>
                        (l.source === d || l.target === d || l.source.id === d.id || l.target.id === d.id) ? 1 : 0.2
                    );
                })
                .on("mouseout", function (event, d) {
                    hideTooltip2D();
                    d3.select(this).style("stroke-width", d.critical ? 3 : 2)
                        .style("stroke", d.critical ? "#ff0000" : "#333");

                    // Reset link opacity
                    link.style("stroke-opacity", 0.6);
                })
                .on("click", function (event, d) {
                    showDeviceDetails(d);
                });

            // Add labels
            if (showLabels) {
                label = g.append("g")
                    .attr("class", "labels")
                    .selectAll("text")
                    .data(nodes)
                    .enter().append("text")
                    .text(d => d.name)
                    .style("font-size", "11px")
                    .style("fill", "#333")
                    .style("font-weight", "600")
                    .style("text-anchor", "middle")
                    .style("pointer-events", "none")
                    .style("text-shadow", "0 0 3px white, 0 0 3px white, 0 0 3px white");
            }

            // CRITICAL FIX: Update positions on simulation tick
            if (simulation) {
                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    if (label) {
                        label
                            .attr("x", d => d.x)
                            .attr("y", d => d.y + 25);
                    }
                });
            }
        }

        function getNodeColor(type) {
            const colors = {
                router: "#ff3333",
                switch: "#0077cc",
                server: "#00aa44",
                windows_server: "#00aa44",
                linux_server: "#00cc66",
                web_server: "#0066cc",
                database: "#8844aa",
                workstation: "#4488ff",
                printer: "#ff8800",
                iot: "#cc9900",
                subnet: "#888888",
                unknown: "#999999"
            };
            return colors[type] || "#999999";
        }

        function showTooltip2D(event, d) {
            const tooltip = document.getElementById('tooltip-2d');
            const device = devicesData.find(dev => dev.ip === d.id) || d;

            let content = `<h4>${d.name}</h4>`;
            content += `<div class="detail-row"><span class="detail-label">IP:</span> <span class="detail-value">${d.id}</span></div>`;
            content += `<div class="detail-row"><span class="detail-label">Type:</span> <span class="detail-value">${d.type}</span></div>`;

            if (device.vendor) {
                content += `<div class="detail-row"><span class="detail-label">Vendor:</span> <span class="detail-value">${device.vendor}</span></div>`;
            }
            if (device.os) {
                content += `<div class="detail-row"><span class="detail-label">OS:</span> <span class="detail-value">${device.os}</span></div>`;
            }
            if (device.services && device.services.length > 0) {
                content += `<div class="detail-row"><span class="detail-label">Services:</span> <span class="detail-value">${device.services.slice(0, 3).join(', ')}</span></div>`;
            }
            if (device.critical) {
                content += `<div class="detail-row"><span class="detail-label" style="color: #ff0000;">CRITICAL</span></div>`;
            }

            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip2D() {
            document.getElementById('tooltip-2d').style.display = 'none';
        }

        function showDeviceDetails(d) {
            const device = devicesData.find(dev => dev.ip === d.id) || d;
            const sidebar = document.getElementById('device-sidebar');
            const title = document.getElementById('sidebar-title');
            const content = document.getElementById('sidebar-content');

            title.textContent = `${device.hostname || device.ip}`;

            let html = '';

            html += '<div class="sidebar-section">';
            html += '<h3>Basic Information</h3>';
            html += '<div class="sidebar-grid">';
            html += `<span class="sidebar-label">IP Address:</span><span class="sidebar-value">${device.ip}</span>`;
            html += `<span class="sidebar-label">Hostname:</span><span class="sidebar-value">${device.hostname || 'N/A'}</span>`;
            html += `<span class="sidebar-label">MAC:</span><span class="sidebar-value">${device.mac || 'N/A'}</span>`;
            html += `<span class="sidebar-label">Vendor:</span><span class="sidebar-value">${device.vendor || 'N/A'}</span>`;
            html += `<span class="sidebar-label">Type:</span><span class="sidebar-value">${device.type}</span>`;
            html += `<span class="sidebar-label">OS:</span><span class="sidebar-value">${device.os || 'N/A'}</span>`;
            html += '</div></div>';

            if (device.services && device.services.length > 0) {
                html += '<div class="sidebar-section">';
                html += '<h3>Services</h3>';
                html += '<ul style="list-style: none; padding: 0;">';
                device.services.forEach(service => {
                    html += `<li style="padding: 2px 0; color: #d4d4d4;">${service}</li>`;
                });
                html += '</ul></div>';
            }

            if (device.open_ports && device.open_ports.length > 0) {
                html += '<div class="sidebar-section">';
                html += '<h3>Open Ports</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
                device.open_ports.forEach(port => {
                    html += `<span style="background: #3e3e42; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">${port}</span>`;
                });
                html += '</div></div>';
            }

            html += '<div class="sidebar-section">';
            html += '<h3>Status & Notes</h3>';
            html += '<div class="sidebar-grid">';
            html += `<span class="sidebar-label">Critical:</span><span class="sidebar-value" style="color: ${device.critical ? '#ff0000' : '#00aa00'}">${device.critical ? 'YES' : 'No'}</span>`;
            html += `<span class="sidebar-label">Last Seen:</span><span class="sidebar-value">${device.last_seen || 'N/A'}</span>`;
            if (device.notes) {
                html += `<span class="sidebar-label">Notes:</span><span class="sidebar-value">${device.notes}</span>`;
            }
            html += '</div></div>';

            content.innerHTML = html;
            sidebar.classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('device-sidebar').classList.remove('open');
        }

        function resetZoom2D() {
            if (zoom && svg) {
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity
                );
            }
        }

        function zoomIn2D() {
            if (zoom && svg) {
                svg.transition().duration(300).call(
                    zoom.scaleBy, 1.5
                );
            }
        }

        function zoomOut2D() {
            if (zoom && svg) {
                svg.transition().duration(300).call(
                    zoom.scaleBy, 1 / 1.5
                );
            }
        }

        function toggleLabels2D() {
            showLabels = document.getElementById('show-labels').checked;
            if (window.d3Initialized) {
                createLayout2D();
            }
        }

        function changeLayout2D() {
            currentLayout = document.getElementById('layout-select').value;
            if (window.d3Initialized) {
                createLayout2D();
            }
        }

        function download2DMap() {
            const svgElement = document.getElementById('network-2d');
            const svgData = new XMLSerializer().serializeToString(svgElement);

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            canvas.width = svgElement.clientWidth;
            canvas.height = svgElement.clientHeight;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function () {
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);

                const link = document.createElement('a');
                link.download = `network_map_2d_${scanTimestamp}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };

            img.src = url;
        }

        function toggleFullscreen2D() {
            const container = document.querySelector('#network-map-tab .visualization');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function dragstarted(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0);
            if (currentLayout === 'force') {
                d.fx = null;
                d.fy = null;
            }
        }

        // 3D Network Functions
        function initialize3DNetwork() {
            const container = document.getElementById('network-3d');
            document.getElementById('loading-3d').style.display = 'flex';

            container.innerHTML = '';

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.fog = new THREE.Fog(0xffffff, 50, 200);

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                60,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(25, 20, 25);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                preserveDrawingBuffer: true,
                alpha: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);

            // Enhanced lighting
            const ambientLight = new THREE.AmbientLight(0x606060, 0.8);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(30, 30, 30);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            scene.add(directionalLight);

            // Add subtle point lights for ambiance
            const pointLight1 = new THREE.PointLight(0x4a90e2, 0.3, 100);
            pointLight1.position.set(20, 15, 20);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xe24a4a, 0.2, 100);
            pointLight2.position.set(-20, 15, -20);
            scene.add(pointLight2);

            // Add grid helper for better depth perception
            const gridHelper = new THREE.GridHelper(50, 50, 0xcccccc, 0xeeeeee);
            gridHelper.position.y = -5;
            scene.add(gridHelper);

            // Create nodes from visualization data
            nodes3D = [];
            labels3D = [];
            const nodeMap = new Map();

            // Create nodes using the positions from threeData
            threeData.positions.forEach((position, index) => {
                const color = new THREE.Color(threeData.colors[index]);
                const labelData = threeData.labels[index];
                const device = devicesData.find(d => d.ip === labelData.text || d.hostname === labelData.text);

                // Node size based on type
                let radius = 0.4;
                if (labelData.critical) radius = 0.7;
                else if (['router', 'switch'].includes(labelData.type)) radius = 0.6;
                else if (labelData.type.includes('server')) radius = 0.5;

                // Create sphere
                const geometry = new THREE.SphereGeometry(radius, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color.clone().multiplyScalar(0.1),
                    shininess: 100,
                    transparent: true,
                    opacity: 0.9
                });

                if (labelData.critical) {
                    material.emissive = color.clone().multiplyScalar(0.3);
                    material.emissiveIntensity = 0.5;
                }

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(position.x, position.y, position.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData = { device: device || labelData, position, index };

                scene.add(mesh);

                const nodeData = {
                    mesh,
                    device: device || labelData,
                    position,
                    label: null
                };

                nodes3D.push(nodeData);
                if (device) {
                    nodeMap.set(device.ip, nodeData);
                }

                // Create label
                create3DLabel(labelData.text, position, labelData.critical, nodeData);
            });

            // Create connections
            if (showConnections && threeData.connections) {
                createConnections3D(threeData.connections);
            }

            // Mouse interaction
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            let hoveredObject = null;
            let selectedObject = null;

            function onMouseMove(event) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(nodes3D.map(n => n.mesh));

                if (hoveredObject && hoveredObject !== selectedObject) {
                    hoveredObject.scale.setScalar(1);
                }

                if (intersects.length > 0) {
                    hoveredObject = intersects[0].object;
                    if (hoveredObject !== selectedObject) {
                        hoveredObject.scale.setScalar(1.1);
                    }
                    container.style.cursor = 'pointer';
                } else {
                    hoveredObject = null;
                    container.style.cursor = 'default';
                }
            }

            function onClick(event) {
                if (hoveredObject) {
                    if (selectedObject) {
                        selectedObject.scale.setScalar(1);
                    }

                    selectedObject = hoveredObject;
                    selectedObject.scale.setScalar(1.2);

                    showDeviceInfo3D(selectedObject.userData.device);
                }
            }

            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('click', onClick);

            // Camera controls
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;

            renderer.domElement.addEventListener('mousedown', (event) => {
                if (event.button === 0) { // Left click only
                    mouseDown = true;
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                    manualRotation = true; // Stop auto-rotation when user interacts
                }
            });

            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });

            renderer.domElement.addEventListener('mousemove', (event) => {
                if (!mouseDown) return;

                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;

                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);

                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            renderer.domElement.addEventListener('wheel', (event) => {
                event.preventDefault();
                const scale = event.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(scale);
                camera.position.clampLength(8, 150);
            });

            // Animation loop - FIXED
            function animate() {
                requestAnimationFrame(animate);

                // REMOVED: The problematic floating animation
                // No more sin wave movement for nodes

                // Auto rotate - FIXED: only when enabled and not manually rotating
                if (autoRotate && !mouseDown && !manualRotation) {
                    const time = Date.now() * 0.001;
                    const radius = camera.position.length();
                    camera.position.x = Math.cos(time * 0.1) * radius; // Slower rotation
                    camera.position.z = Math.sin(time * 0.1) * radius;
                    camera.lookAt(0, 0, 0);
                }

                updateLabelVisibility();
                renderer.render(scene, camera);
            }

            animate();

            // Handle resize
            function onWindowResize() {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }

            window.addEventListener('resize', onWindowResize);

            // Hide loading
            setTimeout(() => {
                document.getElementById('loading-3d').style.display = 'none';
            }, 1000);
        }

        function create3DLabel(text, position, isCritical, nodeData) {
            const labelDiv = document.createElement('div');
            labelDiv.className = 'label3d' + (isCritical ? ' critical' : '');
            labelDiv.textContent = text;
            labelDiv.style.display = show3DLabels ? 'block' : 'none';

            document.getElementById('network-3d').appendChild(labelDiv);

            nodeData.label = {
                element: labelDiv,
                position: position
            };

            labels3D.push(nodeData.label);
        }

        function updateLabelVisibility() {
            if (!camera || !renderer) return;

            labels3D.forEach(label => {
                if (!label || !label.element) return;

                const vector = new THREE.Vector3(
                    label.position.x,
                    label.position.y + 1,
                    label.position.z
                );

                vector.project(camera);

                const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
                const y = (vector.y * -0.5 + 0.5) * renderer.domElement.clientHeight;

                label.element.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;

                // Hide labels that are behind the camera
                if (vector.z > 1) {
                    label.element.style.display = 'none';
                } else {
                    label.element.style.display = show3DLabels ? 'block' : 'none';
                }
            });
        }

        function createConnections3D(connectionData) {
            // Clear existing connections
            connections3D.forEach(conn => {
                if (conn.line) scene.remove(conn.line);
            });
            connections3D = [];

            if (!showConnections) return;

            connectionData.forEach(conn => {
                const points = [
                    new THREE.Vector3(conn.start.x, conn.start.y, conn.start.z),
                    new THREE.Vector3(conn.end.x, conn.end.y, conn.end.z)
                ];

                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({
                    color: new THREE.Color(conn.color),
                    opacity: conn.opacity || 0.6,
                    transparent: true,
                    linewidth: conn.thickness || 1
                });

                const line = new THREE.Line(geometry, material);
                scene.add(line);

                connections3D.push({ line, ...conn });
            });
        }

        function showDeviceInfo3D(device) {
            const panel = document.getElementById('device-info-3d');
            const content = panel.querySelector('.info-content');

            let html = '';

            if (device.hostname || device.ip) {
                html += `<div class="device-title">${device.hostname || device.ip}</div>`;
            }

            html += `<div class="info-row"><span class="info-label">IP:</span><span class="info-value">${device.ip || 'N/A'}</span></div>`;
            html += `<div class="info-row"><span class="info-label">Type:</span><span class="info-value">${device.type || 'unknown'}</span></div>`;

            if (device.vendor) {
                html += `<div class="info-row"><span class="info-label">Vendor:</span><span class="info-value">${device.vendor}</span></div>`;
            }

            if (device.os) {
                html += `<div class="info-row"><span class="info-label">OS:</span><span class="info-value">${device.os}</span></div>`;
            }

            if (device.critical) {
                html += `<div class="info-row"><span class="info-label" style="color: #ff6b6b;">CRITICAL DEVICE</span></div>`;
            }

            if (device.services && device.services.length > 0) {
                html += `<div class="info-row"><span class="info-label">Services:</span><span class="info-value">${device.services.slice(0, 3).join(', ')}</span></div>`;
            }

            content.innerHTML = html;
        }

        function reset3DView() {
            if (camera) {
                camera.position.set(25, 20, 25);
                camera.lookAt(0, 0, 0);
                manualRotation = false; // Allow auto-rotation again if enabled
            }
        }

        function zoom3DIn() {
            if (camera) {
                camera.position.multiplyScalar(0.8);
                camera.position.clampLength(5, 100);
            }
        }

        function zoom3DOut() {
            if (camera) {
                camera.position.multiplyScalar(1.25);
                camera.position.clampLength(5, 100);
            }
        }

        function toggle3DRotation() {
            autoRotate = document.getElementById('auto-rotate').checked;
            if (!autoRotate) {
                manualRotation = false; // Reset manual rotation flag
            }
        }

        function toggle3DConnections() {
            showConnections = document.getElementById('show-connections').checked;
            if (window.threeInitialized && scene) {
                createConnections3D(threeData.connections || []);
            }
        }

        function toggle3DLabels() {
            show3DLabels = document.getElementById('show-3d-labels').checked;
            labels3D.forEach(label => {
                if (label && label.element) {
                    label.element.style.display = show3DLabels ? 'block' : 'none';
                }
            });
        }

        function download3DMap() {
            if (renderer) {
                const link = document.createElement('a');
                link.download = `network_map_3d_${scanTimestamp}.png`;
                link.href = renderer.domElement.toDataURL();
                link.click();
            }
        }

        function toggle3DFullscreen() {
            const container = document.querySelector('#3d-view-tab .visualization');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('click', function (event) {
            const sidebar = document.getElementById('device-sidebar');
            if (sidebar.classList.contains('open') && !sidebar.contains(event.target) && !event.target.closest('circle')) {
                closeSidebar();
            }
        });
    </script>
</body>

</html>
