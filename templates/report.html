<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scan Report - {{ scan_date }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #cccccc;
            background: #1e1e1e;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #4a5fc1 0%, #6b46c1 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .quick-actions {
            background: #252526;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #3e3e42;
        }

        .quick-actions h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #569cd6;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: #569cd6;
            color: white;
        }

        .btn-primary:hover {
            background: #4b8bc8;
        }

        .btn-secondary {
            background: #4ec9b0;
            color: white;
        }

        .btn-secondary:hover {
            background: #43b59f;
        }

        .btn-info {
            background: #4fc1e9;
            color: white;
        }

        .btn-info:hover {
            background: #3badd6;
        }

        .btn-warning {
            background: #ce9178;
            color: white;
        }

        .btn-warning:hover {
            background: #bb8166;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: #2d2d30;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            border: 1px solid #3e3e42;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .summary-card h3 {
            color: #569cd6;
            margin-bottom: 0.5rem;
        }

        .summary-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #d4d4d4;
        }

        .tabs {
            display: flex;
            background: #2d2d30;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #3e3e42;
            border-bottom: none;
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #2d2d30;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1rem;
            font-weight: 500;
            color: #cccccc;
        }

        .tab:hover {
            background: #333337;
        }

        .tab.active {
            background: #1e1e1e;
            color: #569cd6;
            border-bottom: 3px solid #569cd6;
        }

        .tab-content {
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
            border: 1px solid #3e3e42;
            border-top: none;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
        }

        .device-table th {
            background: #2d2d30;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #cccccc;
            border-bottom: 2px solid #3e3e42;
        }

        .device-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #3e3e42;
            color: #d4d4d4;
        }

        .device-table tr:hover {
            background: #252526;
        }

        .device-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .type-router {
            background: #5a3232;
            color: #f48771;
        }

        .type-switch {
            background: #2b3f5c;
            color: #7ca9dd;
        }

        .type-server {
            background: #2d4a3d;
            color: #6fc28b;
        }

        .type-workstation {
            background: #4a3a5a;
            color: #b99bd8;
        }

        .type-printer {
            background: #5a4226;
            color: #daa674;
        }

        .type-iot {
            background: #5a5226;
            color: #d4c896;
        }

        .type-unknown {
            background: #3e3e42;
            color: #858585;
        }

        .critical {
            color: #f48771;
            font-weight: bold;
        }

        .services {
            font-size: 0.875rem;
            color: #858585;
        }

        .visualization {
            width: 100%;
            height: 600px;
            background: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid #3e3e42;
        }

        #network-2d,
        #network-3d {
            width: 100%;
            height: 100%;
        }

        .subnet-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .subnet-card {
            background: #252526;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }

        .subnet-card h4 {
            color: #569cd6;
            margin-bottom: 0.5rem;
        }

        .subnet-card ul {
            list-style: none;
            padding-left: 0;
        }

        .subnet-card li {
            color: #cccccc;
            padding: 0.25rem 0;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .device-table {
                font-size: 0.875rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media print {
            body {
                background: white;
                color: black;
            }

            .quick-actions,
            .tabs,
            .tab-content.hidden {
                display: none !important;
            }

            .tab-content {
                display: block !important;
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ddd;
            }

            .container {
                max-width: 100%;
            }

            .device-table th,
            .device-table td {
                border: 1px solid #ddd;
                color: black;
            }

            .summary-card,
            .subnet-card {
                background: white;
                border: 1px solid #ddd;
                color: black;
            }

            header {
                background: #667eea;
                color: white;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Network Scan Report</h1>
            <p>Generated on {{ timestamp }}</p>
        </header>

        <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="window.print()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2">
                        </path>
                        <rect x="6" y="14" width="12" height="8" rx="1"></rect>
                    </svg>
                    Print Report
                </button>

                <button class="action-btn btn-secondary" onclick="downloadCSV()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                    </svg>
                    Download CSV
                </button>

                <button class="action-btn btn-info" onclick="compareToLastScan()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="18" r="3"></circle>
                        <circle cx="6" cy="6" r="3"></circle>
                        <path d="M13 6h3a2 2 0 012 2v7M6 11h3a2 2 0 002-2V6"></path>
                    </svg>
                    Compare to Last Scan
                </button>

                <button class="action-btn btn-warning" onclick="refreshScan()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15">
                        </path>
                    </svg>
                    Run New Scan
                </button>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Devices</h3>
                <div class="number">{{ total_devices }}</div>
            </div>

            <div class="summary-card">
                <h3>Critical Devices</h3>
                <div class="number">{{ critical_devices|length }}</div>
            </div>

            <div class="summary-card">
                <h3>Device Types</h3>
                <div class="number">{{ device_types|length }}</div>
            </div>

            <div class="summary-card">
                <h3>Subnets</h3>
                <div class="number">{{ subnet_summary|length }}</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('devices')">Devices</button>
            <button class="tab" onclick="showTab('network-map')">2D Map</button>
            <button class="tab" onclick="showTab('3d-view')">3D Map</button>
            <button class="tab" onclick="showTab('subnets')">Subnets</button>
        </div>

        <div id="devices-tab" class="tab-content">
            <h2>Discovered Devices</h2>
            <table class="device-table">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Hostname</th>
                        <th>Type</th>
                        <th>Vendor</th>
                        <th>OS</th>
                        <th>Services</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.ip }}</td>
                        <td>{{ device.hostname or '-' }}</td>
                        <td><span class="device-type type-{{ device.type }}">{{ device.type }}</span></td>
                        <td>{{ device.vendor or '-' }}</td>
                        <td>{{ device.os or '-' }}</td>
                        <td class="services">
                            {% if device.services %}
                            {{ device.services[:3]|join(', ') }}
                            {% if device.services|length > 3 %}...{% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if device.critical %}<span class="critical">CRITICAL</span>{% endif %}
                            {{ device.notes or '' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="network-map-tab" class="tab-content hidden">
            <h2>Network Topology</h2>
            <div class="visualization">
                <svg id="network-2d"></svg>
            </div>
        </div>

        <div id="3d-view-tab" class="tab-content hidden">
            <h2>3D Network View</h2>
            <div class="visualization">
                <div id="network-3d"></div>
            </div>
        </div>

        <div id="subnets-tab" class="tab-content hidden">
            <h2>Subnet Summary</h2>
            <div class="subnet-summary">
                {% for subnet in subnet_summary %}
                <div class="subnet-card">
                    <h4>{{ subnet.network }}</h4>
                    <p><strong>Devices:</strong> {{ subnet.device_count }}</p>
                    <p><strong>Types:</strong></p>
                    <ul>
                        {% for type, count in subnet.types.items() %}
                        <li>{{ type }}: {{ count }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Store devices data for CSV export
        const devicesData = {{ devices | tojson }};
        const scanTimestamp = '{{ scan_timestamp }}';

        // Debug: Log the timestamp to console
        console.log('Scan timestamp:', scanTimestamp);
        console.log('Expected comparison file:', `comparison_${scanTimestamp}.html`);

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');

            // Initialize visualizations when shown
            if (tabName === 'network-map' && !window.d3Initialized) {
                initializeD3Network();
                window.d3Initialized = true;
            } else if (tabName === '3d-view' && !window.threeInitialized) {
                initialize3DNetwork();
                window.threeInitialized = true;
            }
        }

        // Download CSV function
        function downloadCSV() {
            let csv = 'IP,Hostname,MAC,Vendor,Type,OS,Services,Open Ports,Critical,Notes\n';

            devicesData.forEach(device => {
                const row = [
                    device.ip,
                    device.hostname || '',
                    device.mac || '',
                    device.vendor || '',
                    device.type || 'unknown',
                    device.os || '',
                    (device.services || []).join(';'),
                    (device.open_ports || []).join(';'),
                    device.critical ? 'Yes' : 'No',
                    device.notes || ''
                ];

                // Escape values containing commas
                const escapedRow = row.map(value => {
                    const str = String(value);
                    return str.includes(',') ? `"${str}"` : str;
                });

                csv += escapedRow.join(',') + '\n';
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network_scan_${scanTimestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Compare to last scan
        function compareToLastScan() {
            // Use the scan timestamp that matches the file naming convention
            const comparisonUrl = `comparison_${scanTimestamp}.html`;

            // Try to check if the comparison report exists
            fetch(comparisonUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        // File exists, navigate to it
                        window.location.href = comparisonUrl;
                    } else {
                        // File doesn't exist
                        alert('No comparison report available. This might be your first scan or there are no previous scans to compare against.');
                    }
                })
                .catch(() => {
                    // Fallback - just try to navigate (works in most browsers)
                    window.location.href = comparisonUrl;
                });
        }

        // Refresh scan (open mapper.py)
        function refreshScan() {
            alert('To run a new scan, please return to the NetworkMapper CLI and select "Run Network Scan"');
        }

        // D3.js Network Visualization
        function initializeD3Network() {
            const data = {{ d3_data | safe
        }};
        const width = document.getElementById('network-2d').clientWidth;
        const height = 600;

        const svg = d3.select("#network-2d")
            .attr("width", width)
            .attr("height", height);

        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg.append("g")
            .selectAll("line")
            .data(data.links)
            .enter().append("line")
            .style("stroke", "#666")
            .style("stroke-opacity", 0.6)
            .style("stroke-width", d => Math.sqrt(d.value));

        const node = svg.append("g")
            .selectAll("circle")
            .data(data.nodes)
            .enter().append("circle")
            .attr("r", d => d.critical ? 10 : 6)
            .style("fill", d => {
                const colors = {
                    router: "#f48771",
                    switch: "#7ca9dd",
                    server: "#6fc28b",
                    workstation: "#b99bd8",
                    subnet: "#858585",
                    unknown: "#666666"
                };
                return colors[d.type] || "#666666";
            })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        const label = svg.append("g")
            .selectAll("text")
            .data(data.nodes)
            .enter().append("text")
            .text(d => d.name)
            .style("font-size", "10px")
            .style("fill", "#cccccc");

        node.append("title")
            .text(d => `${d.name}\nType: ${d.type}\nServices: ${(d.services || []).join(", ")}`);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x + 12)
                .attr("y", d => d.y + 3);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        }

        // Three.js 3D Network Visualization
        function initialize3DNetwork() {
            const data = {{ three_data | safe
        }};
        const container = document.getElementById('network-3d');

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1e1e1e);

        const camera = new THREE.PerspectiveCamera(
            75,
            container.clientWidth / container.clientHeight,
            0.1,
            1000
        );
        camera.position.set(data.camera.x, data.camera.y, data.camera.z);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight.position.set(10, 10, 5);
        scene.add(directionalLight);

        // Add nodes
        const nodeGeometry = new THREE.SphereGeometry(0.3, 16, 16);
        data.positions.forEach((pos, i) => {
            const material = new THREE.MeshPhongMaterial({
                color: data.colors[i],
                emissive: data.colors[i],
                emissiveIntensity: 0.2
            });
            const node = new THREE.Mesh(nodeGeometry, material);
            node.position.set(pos.x, pos.y, pos.z);
            scene.add(node);
        });

        // Add connections
        data.connections.forEach(conn => {
            const points = [
                new THREE.Vector3(conn.start.x, conn.start.y, conn.start.z),
                new THREE.Vector3(conn.end.x, conn.end.y, conn.end.z)
            ];
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({
                color: conn.color,
                opacity: conn.opacity,
                transparent: true
            });
            const line = new THREE.Line(geometry, material);
            scene.add(line);
        });

        // Mouse controls
        let mouseX = 0, mouseY = 0;
        container.addEventListener('mousemove', (event) => {
            mouseX = (event.offsetX / container.clientWidth) * 2 - 1;
            mouseY = -(event.offsetY / container.clientHeight) * 2 + 1;
        });

        function animate() {
            requestAnimationFrame(animate);

            // Rotate based on mouse position
            scene.rotation.y += (mouseX * 0.05 - scene.rotation.y) * 0.05;
            scene.rotation.x += (mouseY * 0.05 - scene.rotation.x) * 0.05;

            renderer.render(scene, camera);
        }

        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
        }
    </script>
</body>

</html>
